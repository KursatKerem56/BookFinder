@using System.Security.Claims
@{
  ViewData["Title"] = "My Library";
  var library = ViewBag.Library as IEnumerable<dynamic>;
  var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>@ViewData["Title"] - BookFinder</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .library-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 0;
      margin-bottom: 30px;
    }

    .book-card {
      transition: transform 0.3s;
      height: 100%;
    }

    .book-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .book-cover {
      height: 350px;
      object-fit: cover;
      width: 100%;
    }

    .status-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.75rem;
    }

    .score-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: gold;
      padding: 5px 10px;
      border-radius: 20px;
      font-weight: bold;
    }

    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }
  </style>
</head>

<body>
  @await Html.PartialAsync("~/Views/Shared/Navbar.cshtml")

  <div class="library-header">
    <div class="container">
      <h1 class="display-4 fw-bold">
        <i class="bi bi-bookmark-fill"></i> My Library
      </h1>
      <p class="lead mb-0">
        <i class="bi bi-book"></i> @(library?.Count() ?? 0) Books in Collection
      </p>
    </div>
  </div>

  <div class="container mb-5">
    @if (library != null && library.Any())
    {
      <div class="filter-section">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-bold">Filter by Status</label>
            <select id="statusFilter" class="form-select">
              <option value="all">All Books</option>
              <option value="Reading">Reading</option>
              <option value="Completed">Completed</option>
              <option value="Plan to Read">Plan to Read</option>
              <option value="Dropped">Dropped</option>
              <option value="On Hold">On Hold</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">Sort by</label>
            <select id="sortBy" class="form-select">
              <option value="update">Last Updated</option>
              <option value="title">Title</option>
              <option value="score">My Score</option>
              <option value="progress">Progress</option>
            </select>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <p class="text-muted">
          <i class="bi bi-info-circle"></i>
          Showing <span id="bookCount">@library.Count()</span> books
        </p>
      </div>

      <div class="row g-4" id="libraryContainer">
        @foreach (var entry in library)
        {
          var statusColor = entry.Condition switch
          {
            "Reading" => "bg-primary",
            "Completed" => "bg-success",
            "Plan to Read" => "bg-info",
            "Dropped" => "bg-danger",
            "On Hold" => "bg-warning text-dark",
            _ => "bg-secondary"
          };

          <div class="col-md-6 col-lg-3 library-item" data-status="@entry.Condition"
            data-title="@entry.Title?.ToString().ToLower()" data-score="@entry.Score" data-progress="@entry.Progress"
            data-update="@(entry.UpdateDate?.ToString("yyyyMMddHHmmss"))">
            <div class="card book-card">
              <div class="position-relative">
                <img src="@entry.ImageURL" class="card-img-top book-cover" alt="@entry.Title">
                <span class="status-badge @statusColor">
                  @entry.Condition
                </span>
                <span class="score-badge">
                  <i class="bi bi-star-fill"></i> @entry.Score/10
                </span>
              </div>
              <div class="card-body">
                <h5 class="card-title text-truncate" title="@entry.Title">
                  @entry.Title
                </h5>

                <div class="mb-2">
                  <small class="text-muted">
                    <i class="bi bi-book"></i> Progress: @entry.Progress pages
                  </small>
                </div>

                <div class="mb-3">
                  <small class="text-muted">
                    <i class="bi bi-clock"></i>
                    Updated: @((entry.UpdateDate as DateTime?)?.ToString("MMM dd, yyyy") ?? "Unknown")
                  </small>
                </div>

                <div class="d-grid gap-2">
                  <a href="/books/details/@entry.BookId">
                    <i class="bi bi-eye"></i> View Details
                  </a>
                  <button class="btn btn-outline-primary btn-sm update-btn" data-book-id="@entry.BookId"
                    data-bs-toggle="modal" data-bs-target="#updateModal" data-title="@entry.Title"
                    data-progress="@entry.Progress" data-score="@entry.Score" data-status="@entry.Condition">
                    <i class="bi bi-pencil"></i> Update
                  </button>
                  <button class="btn btn-outline-danger btn-sm delete-btn" data-book-id="@entry.BookId">
                    <i class="bi bi-trash"></i> Remove
                  </button>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    }
    else
    {
      <div class="text-center py-5">
        <i class="bi bi-bookmark display-1 text-muted"></i>
        <h3 class="mt-3">Your library is empty</h3>
        <p class="text-muted">Start adding books to track your reading journey!</p>
        <a href="/books">
          <i class="bi bi-search"></i> Browse Books
        </a>
      </div>
    }
  </div>

  <!-- Update Modal -->
  <div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-pencil"></i> Update Library Entry
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="updateForm">
            <input type="hidden" id="updateBookId">

            <h6 id="updateBookTitle" class="mb-3"></h6>

            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" id="updateStatus">
                <option value="1">Reading</option>
                <option value="2">Completed</option>
                <option value="3">Plan to Read</option>
                <option value="4">Dropped</option>
                <option value="5">On Hold</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Progress (pages)</label>
              <input type="number" class="form-control" id="updateProgress" min="0">
            </div>

            <div class="mb-3">
              <label class="form-label">Score (1-10)</label>
              <input type="number" class="form-control" id="updateScore" min="1" max="10">
            </div>

            <div id="updateAlert"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveUpdateBtn">
            <i class="bi bi-check-circle"></i> Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const userId = '@userId';

    // Filter and sort
    const statusFilter = document.getElementById('statusFilter');
    const sortBy = document.getElementById('sortBy');
    const libraryContainer = document.getElementById('libraryContainer');
    const bookCount = document.getElementById('bookCount');

    function filterAndSort() {
      const status = statusFilter.value;
      const sort = sortBy.value;
      const items = Array.from(document.querySelectorAll('.library-item'));

      let visibleCount = 0;

      items.forEach(item => {
        if (status === 'all' || item.dataset.status === status) {
          item.style.display = '';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });

      const visibleItems = items.filter(item => item.style.display !== 'none');
      visibleItems.sort((a, b) => {
        if (sort === 'title') {
          return a.dataset.title.localeCompare(b.dataset.title);
        } else if (sort === 'score') {
          return parseInt(b.dataset.score) - parseInt(a.dataset.score);
        } else if (sort === 'progress') {
          return parseInt(b.dataset.progress) - parseInt(a.dataset.progress);
        } else {
          return b.dataset.update.localeCompare(a.dataset.update);
        }
      });

      visibleItems.forEach(item => libraryContainer.appendChild(item));
      bookCount.textContent = visibleCount;
    }

    statusFilter?.addEventListener('change', filterAndSort);
    sortBy?.addEventListener('change', filterAndSort);

    // Update button
    document.querySelectorAll('.update-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('updateBookId').value = btn.dataset.bookId;
        document.getElementById('updateBookTitle').textContent = btn.dataset.title;
        document.getElementById('updateProgress').value = btn.dataset.progress;
        document.getElementById('updateScore').value = btn.dataset.score;

        const statusMap = {
          'Reading': '1', 'Completed': '2', 'Plan to Read': '3',
          'Dropped': '4', 'On Hold': '5'
        };
        document.getElementById('updateStatus').value = statusMap[btn.dataset.status] || '1';
      });
    });

    // Save update
    document.getElementById('saveUpdateBtn')?.addEventListener('click', async () => {
      const data = {
        userId: parseInt(userId),
        bookId: parseInt(document.getElementById('updateBookId').value),
        progress: parseInt(document.getElementById('updateProgress').value),
        score: parseInt(document.getElementById('updateScore').value),
        condition: parseInt(document.getElementById('updateStatus').value)
      };

      try {
        const response = await fetch('/books/library/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          location.reload();
        } else {
          showAlert('updateAlert', 'Error updating entry', 'danger');
        }
      } catch (error) {
        showAlert('updateAlert', 'Network error', 'danger');
      }
    });

    // Delete button
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Remove this book from your library?')) return;

        const bookId = btn.dataset.bookId;

        try {
          const response = await fetch('/books/library/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: parseInt(userId), bookId: parseInt(bookId) })
          });

          if (response.ok) {
            location.reload();
          } else {
            alert('Error removing book');
          }
        } catch (error) {
          alert('Network error');
        }
      });
    });

    function showAlert(containerId, message, type) {
      const container = document.getElementById(containerId);
      container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
    }
  </script>
</body>

</html>
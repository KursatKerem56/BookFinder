@using System.Security.Claims
@{
  ViewData["Title"] = "Book Details";
  var book = ViewBag.Book;
  var reviews = ViewBag.Reviews as IEnumerable<dynamic>;
  var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
  var isAuthenticated = User.Identity?.IsAuthenticated == true;
}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>@book?.Title - BookFinder</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <style>
    .book-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 40px 0;
      color: white;
    }

    .book-cover {
      max-height: 500px;
      object-fit: contain;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }

    .review-card {
      border-left: 4px solid #667eea;
    }

    .comment-card {
      border-left: 3px solid #764ba2;
      margin-left: 30px;
    }

    .spoiler-blur {
      filter: blur(5px);
      cursor: pointer;
      user-select: none;
    }

    .spoiler-warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  @await Html.PartialAsync("~/Views/Shared/Navbar.cshtml")

  @if (book != null)
  {
    <div class="book-header mb-4">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-3 text-center mb-3 mb-md-0">
            <img src="@book.ImageURL" class="book-cover img-fluid" alt="@book.Title">
          </div>
          <div class="col-md-9">
            <h1 class="display-4 fw-bold mb-3">@book.Title</h1>
            <p class="lead mb-2">
              <i class="bi bi-person"></i> by <strong>@book.Author</strong>
            </p>
            <p class="mb-2">
              <i class="bi bi-building"></i> Published by <strong>@book.Publisher</strong>
            </p>
            @if (!string.IsNullOrEmpty(book.Serie))
            {
              <p class="mb-2">
                <i class="bi bi-collection"></i> Series: <strong>@book.Serie</strong>
              </p>
            }
            @if (!string.IsNullOrEmpty(book.Genre))
            {
              <p class="mb-2">
                <i class="bi bi-tags"></i> @book.Genre
              </p>
            }
            <p class="mb-2">
              <i class="bi bi-calendar"></i>
              @((book.PublicationDate as DateTime?)?.ToString("MMMM dd, yyyy") ?? "Unknown")
            </p>
            <p class="mb-0">
              <i class="bi bi-file-text"></i> @(book.PageCount ?? 0) pages
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="container mb-5">
      @if (isAuthenticated)
      {
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="card-title">
              <i class="bi bi-bookmark-plus"></i> Add to My Library
            </h5>
            <form id="addToLibraryForm">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Status</label>
                  <select class="form-select" id="statusId" required>
                    <option value="1">Reading</option>
                    <option value="2">Completed</option>
                    <option value="3">Plan to Read</option>
                    <option value="4">Dropped</option>
                    <option value="5">On Hold</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Progress (pages)</label>
                  <input type="number" class="form-control" id="progress" min="0" max="@book.PageCount" value="0" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Score (1-10)</label>
                  <input type="number" class="form-control" id="score" min="1" max="10" value="5" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">&nbsp;</label>
                  <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-plus-circle"></i> Add to Library
                  </button>
                </div>
              </div>
            </form>
            <div id="libraryAlert" class="mt-3"></div>
          </div>
        </div>
      }

      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="bi bi-chat-left-text"></i> Reviews
            <span class="badge bg-light text-dark">@(reviews?.Count() ?? 0)</span>
          </h4>
        </div>
        <div class="card-body">
          @if (isAuthenticated)
          {
            <form id="reviewForm" class="mb-4">
              <h5>Write a Review</h5>
              <div class="mb-3">
                <textarea class="form-control" id="reviewContent" rows="4"
              placeholder="Share your thoughts about this book..." required></textarea>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="reviewSpoilers">
                <label class="form-check-label" for="reviewSpoilers">
                  <i class="bi bi-exclamation-triangle text-warning"></i> Contains Spoilers
                </label>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-send"></i> Post Review
              </button>
            </form>
            <div id="reviewAlert"></div>
            <hr>
          }

          @if (reviews != null && reviews.Any())
          {
            foreach (var review in reviews)
            {
              <div class="card review-card mb-3">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <h6 class="mb-0">
                        <i class="bi bi-person-circle"></i> @review.User
                      </h6>
                      <small class="text-muted">
                        <i class="bi bi-clock"></i>
                        @((review.Date as DateTime?)?.ToString("MMM dd, yyyy HH:mm") ?? "Unknown")
                      </small>
                    </div>
                    @if (isAuthenticated && review.User == User.Identity.Name)
                    {
                      <button class="btn btn-sm btn-danger delete-review-btn" data-review-id="@review.PostId">
                        <i class="bi bi-trash"></i>
                      </button>
                    }
                  </div>

                  @if (review.Spoiler)
                  {
                    <div class="spoiler-warning">
                      <i class="bi bi-exclamation-triangle"></i>
                      <strong>Spoiler Warning!</strong> Click to reveal
                    </div>
                    <div class="spoiler-blur" onclick="this.classList.remove('spoiler-blur')">
                      @review.ReviewText
                    </div>
                  }
                  else
                  {
                    <p class="mb-3">@review.ReviewText</p>
                  }

                  @if (review.Comments != null && ((IEnumerable<dynamic>)review.Comments).Any())
                  {
                    <div class="mt-3">
                      <h6><i class="bi bi-chat"></i> Comments:</h6>
                      @foreach (var comment in review.Comments)
                      {
                        <div class="card comment-card mb-2">
                          <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-start">
                              <div>
                                <strong>@comment.User</strong>
                                <small class="text-muted ms-2">
                                  @((comment.Date as DateTime?)?.ToString("MMM dd, HH:mm") ?? "Unknown")
                                </small>
                              </div>
                              @if (isAuthenticated && comment.User == User.Identity.Name)
                              {
                                <button class="btn btn-sm btn-danger delete-comment-btn" data-comment-id="@comment.ID">
                                  <i class="bi bi-trash"></i>
                                </button>
                              }
                            </div>
                            @if (comment.Spoiler)
                            {
                              <div class="spoiler-blur small mt-1" onclick="this.classList.remove('spoiler-blur')">
                                @comment.CommentText
                              </div>
                            }
                            else
                            {
                              <p class="mb-0 small mt-1">@comment.CommentText</p>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  }

                  @if (isAuthenticated)
                  {
                    <button class="btn btn-sm btn-outline-primary mt-2 reply-btn" data-review-id="@review.PostId">
                      <i class="bi bi-reply"></i> Reply
                    </button>
                    <div class="comment-form mt-2" id="commentForm-@review.PostId" style="display: none;">
                      <div class="input-group">
                        <input type="text" class="form-control comment-input" placeholder="Write a comment...">
                        <button class="btn btn-primary post-comment-btn" data-review-id="@review.PostId">
                          <i class="bi bi-send"></i>
                        </button>
                      </div>
                      <div class="form-check mt-2">
                        <input class="form-check-input comment-spoiler" type="checkbox">
                        <label class="form-check-label">Contains Spoilers</label>
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          }
          else
          {
            <p class="text-muted text-center">No reviews yet. Be the first to review this book!</p>
          }
        </div>
      </div>

      <a href="/books">
        <i class="bi bi-arrow-left"></i> Back to Books
      </a>
    </div>
  }

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const userId = '@userId';
    const bookId = '@book?.ID';

    // Add to library
    document.getElementById('addToLibraryForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        userId: parseInt(userId),
        bookId: parseInt(bookId),
        progress: parseInt(document.getElementById('progress').value),
        score: parseInt(document.getElementById('score').value),
        condition: parseInt(document.getElementById('statusId').value)
      };

      try {
        const response = await fetch('/books/library/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.text();
        showAlert('libraryAlert', result, response.ok ? 'success' : 'danger');
      } catch (error) {
        showAlert('libraryAlert', 'Error adding book to library', 'danger');
      }
    });

    // Post review
    document.getElementById('reviewForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        userId: parseInt(userId),
        bookId: parseInt(bookId),
        content: document.getElementById('reviewContent').value,
        containsSpoilers: document.getElementById('reviewSpoilers').checked
      };

      try {
        const response = await fetch('/books/create-review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          showAlert('reviewAlert', 'Review posted successfully!', 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          showAlert('reviewAlert', 'Error posting review', 'danger');
        }
      } catch (error) {
        showAlert('reviewAlert', 'Network error', 'danger');
      }
    });

    // Delete review
    document.querySelectorAll('.delete-review-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this review?')) return;

        const reviewId = btn.dataset.reviewId;
        try {
          const response = await fetch('/books/delete-review', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: parseInt(userId), reviewId: parseInt(reviewId) })
          });

          if (response.ok) {
            location.reload();
          } else {
            alert('Error deleting review');
          }
        } catch (error) {
          alert('Network error');
        }
      });
    });

    // Reply buttons
    document.querySelectorAll('.reply-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const reviewId = btn.dataset.reviewId;
        const form = document.getElementById(`commentForm-${reviewId}`);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
      });
    });

    // Post comment
    document.querySelectorAll('.post-comment-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const reviewId = btn.dataset.reviewId;
        const form = document.getElementById(`commentForm-${reviewId}`);
        const input = form.querySelector('.comment-input');
        const spoilerCheck = form.querySelector('.comment-spoiler');

        if (!input.value.trim()) return;

        const data = {
          userId: parseInt(userId),
          reviewId: parseInt(reviewId),
          content: input.value,
          containsSpoilers: spoilerCheck.checked
        };

        try {
          const response = await fetch('/books/create-comment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (response.ok) {
            location.reload();
          } else {
            alert('Error posting comment');
          }
        } catch (error) {
          alert('Network error');
        }
      });
    });

    // Delete comment
    document.querySelectorAll('.delete-comment-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete this comment?')) return;

        const commentId = btn.dataset.commentId;
        try {
          const response = await fetch('/books/delete-comment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: parseInt(userId), commentId: parseInt(commentId) })
          });

          if (response.ok) {
            location.reload();
          } else {
            alert('Error deleting comment');
          }
        } catch (error) {
          alert('Network error');
        }
      });
    });

    function showAlert(containerId, message, type) {
      const container = document.getElementById(containerId);
      container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
    }
  </script>
</body>

</html>